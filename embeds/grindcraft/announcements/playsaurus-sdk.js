(function(c,u){typeof exports=="object"&&typeof module<"u"?module.exports=u():typeof define=="function"&&define.amd?define(u):(c=typeof globalThis<"u"?globalThis:c||self,c.Playsaurus=u())})(this,function(){"use strict";var ee=Object.defineProperty;var te=(c,u,m)=>u in c?ee(c,u,{enumerable:!0,configurable:!0,writable:!0,value:m}):c[u]=m;var i=(c,u,m)=>(te(c,typeof u!="symbol"?u+"":u,m),m);let c;const u=new Uint8Array(16);function m(){if(!c&&(c=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!c))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return c(u)}const o=[];for(let n=0;n<256;++n)o.push((n+256).toString(16).slice(1));function V(n,e=0){return o[n[e+0]]+o[n[e+1]]+o[n[e+2]]+o[n[e+3]]+"-"+o[n[e+4]]+o[n[e+5]]+"-"+o[n[e+6]]+o[n[e+7]]+"-"+o[n[e+8]]+o[n[e+9]]+"-"+o[n[e+10]]+o[n[e+11]]+o[n[e+12]]+o[n[e+13]]+o[n[e+14]]+o[n[e+15]]}const R={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function D(n,e,t){if(R.randomUUID&&!e&&!n)return R.randomUUID();n=n||{};const s=n.random||(n.rng||m)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,e){t=t||0;for(let r=0;r<16;++r)e[t+r]=s[r];return e}return V(s)}class S{constructor(e,t,s,r,a){i(this,"id");i(this,"session");i(this,"name");i(this,"timestamp");i(this,"properties");i(this,"sendCount",0);this.id=a??D(),this.session=e,this.name=t,this.timestamp=s,this.properties=r??{}}toJSON(){return{id:this.id,name:this.name,t:this.timestamp.toISOString(),properties:Object.keys(this.properties).length>0?this.properties:void 0}}toStorage(){return this.toJSON()}static fromStorage(e,t){const s=t.name,r=new Date(t.t),a=t.properties,l=t.id;return new S(e,s,r,a,l)}}class H{constructor(e){i(this,"session");i(this,"status","pending");i(this,"shouldRetry",!1);if(this.events=e,e.length===0)throw new Error("The events list cannot be empty.");this.events=e,this.session=e[0].session;for(const t of e)if(t.session!==this.session)throw new Error("All events must belong to the same session.")}markAsFailAndRetry(){this.status="failed",this.shouldRetry=!0}markAsFailAndSkip(){this.status="failed",this.shouldRetry=!1}markAsSent(){this.status="sent",this.shouldRetry=!1}}class v{constructor(){i(this,"id",null);i(this,"pendingEvents",[]);i(this,"nextHeartbeatAt",null);i(this,"userAtomicId",null);i(this,"userId",null);i(this,"userUid",null);i(this,"gameVersion",null);i(this,"analyticsSdkVersion",null);i(this,"osName",null);i(this,"osVersion",null);i(this,"deviceModel",null);i(this,"deviceType",null);i(this,"deviceManufacturer",null);i(this,"deviceLocale",null);i(this,"gameLocale",null);i(this,"deviceRamMb",null);i(this,"deviceCpuCores",null);i(this,"deviceCpuMhz",null);i(this,"deviceVramMb",null);i(this,"gameGraphicsApi",null);i(this,"screenWidth",null);i(this,"screenHeight",null);i(this,"screenDpi",null);i(this,"screenCount",null);i(this,"userAgent",null);i(this,"connectionType",null);i(this,"gamePlatform",null);i(this,"deviceGaid",null);i(this,"deviceIdfa",null)}get isSubmitted(){return this.id!==null}pushEvent(e,t){const s=new S(this,e,new Date,t);return this.pendingEvents.push(s),s}dequeueEvents(e){return this.pendingEvents.splice(0,e)}returnFailedEventsToQueue(e){this.pendingEvents.push(...e)}createBatches(e){const t=[];let s=this.dequeueEvents(e);for(;s.length>0;)t.push(new H(s)),s=this.dequeueEvents(e);return t}toJSON(){return v._removeNulls({user_atomic_id:this.userAtomicId,user_id:this.userId,user_uid:this.userUid,game_version:this.gameVersion,analytics_sdk_version:this.analyticsSdkVersion,os_name:this.osName,os_version:this.osVersion,device_model:this.deviceModel,device_type:this.deviceType,device_manufacturer:this.deviceManufacturer,device_locale:this.deviceLocale,game_locale:this.gameLocale,device_ram_mb:this.deviceRamMb,device_cpu_cores:this.deviceCpuCores,device_cpu_mhz:this.deviceCpuMhz,device_vram_mb:this.deviceVramMb,game_graphics_api:this.gameGraphicsApi,screen_width:this.screenWidth,screen_height:this.screenHeight,screen_dpi:this.screenDpi,screen_count:this.screenCount,user_agent:this.userAgent,connection_type:this.connectionType,game_platform:this.gamePlatform,device_gaid:this.deviceGaid,device_idfa:this.deviceIdfa})}static _removeNulls(e){return Object.keys(e).forEach(t=>{(e[t]===null||e[t]===void 0)&&delete e[t]}),e}toStorage(){return{...this.toJSON(),pending_events:this.pendingEvents.map(e=>e.toStorage())}}static fromStorage(e){const t=Object.assign(new v,v._removeNulls({userAtomicId:e.user_atomic_id,userId:e.user_id,userUid:e.user_uid,gameVersion:e.game_version,analyticsSdkVersion:e.analytics_sdk_version,osName:e.os_name,osVersion:e.os_version,deviceModel:e.device_model,deviceType:e.device_type,deviceManufacturer:e.device_manufacturer,deviceLocale:e.device_locale,gameLocale:e.game_locale,deviceRamMb:e.device_ram_mb,deviceCpuCores:e.device_cpu_cores,deviceCpuMhz:e.device_cpu_mhz,deviceVramMb:e.device_vram_mb,gameGraphicsApi:e.game_graphics_api,screenWidth:e.screen_width,screenHeight:e.screen_height,screenDpi:e.screen_dpi,screenCount:e.screen_count,userAgent:e.user_agent,connectionType:e.connection_type,gamePlatform:e.game_platform}));return e.pending_events&&(t.pendingEvents=e.pending_events.map(s=>S.fromStorage(t,s))),t}}var h=(n=>(n.Offline="offline",n.Online="online",n.Wifi="wifi",n.Ethernet="ethernet",n.Mobile="mobile",n))(h||{}),I=(n=>(n.Windows="windows",n.Linux="linux",n.MacOS="macos",n.Android="android",n.IOS="ios",n))(I||{});class N{static getConnectionType(){const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(!e)return h.Online;const t={bluetooth:h.Mobile,cellular:h.Mobile,ethernet:h.Ethernet,none:h.Offline,wifi:h.Wifi,wimax:h.Mobile,unknown:null}[e.type];return t||(e.saveData===!0?h.Mobile:h.Online)}}const E=class E{constructor(){i(this,"_atomicId",null)}static get instance(){return this._instance??(this._instance=new E),this._instance}async getId(){return this._atomicId?this._atomicId:(this._atomicId=localStorage.getItem("playsaurus-atomic-id"),this._atomicId?this._atomicId:(this._atomicId=D(),localStorage.setItem("playsaurus-atomic-id",this._atomicId),this._atomicId))}};i(E,"_instance",null);let y=E;class k{async collect(e,t){return e.gameVersion=t.gameVersion,e.analyticsSdkVersion=t.analyticsSdkVersion,e.gameLocale=t.gameLocale,e.gamePlatform=t.gamePlatform,e.userUid=t.userUid,e.userAtomicId=await this.getAtomicId(),e.connectionType=this.getConnectionType(),e.osName=this.getOsName(),e.osVersion=this.getOsVersion(),e.deviceModel=null,e.deviceType=null,e.deviceManufacturer=null,e.deviceLocale=navigator.language,e.deviceRamMb=this.getDeviceRamMb(),e.deviceCpuCores=null,e.deviceCpuMhz=null,e.deviceVramMb=null,e.gameGraphicsApi=null,e.screenWidth=this.getScreenWidth(),e.screenHeight=this.getScreenHeight(),e.screenDpi=this.getScreenDpi(),e.screenCount=null,e.userAgent=navigator.userAgent,Promise.resolve()}async getAtomicId(){return y.instance.getId()}getOsName(){return null}getOsVersion(){return null}getDeviceRamMb(){return typeof navigator.deviceMemory<"u"?navigator.deviceMemory*1024:null}getScreenWidth(){return window.devicePixelRatio?Math.floor(window.screen.width*window.devicePixelRatio):window.screen.width}getScreenHeight(){return window.devicePixelRatio?Math.floor(window.screen.height*window.devicePixelRatio):window.screen.height}getScreenDpi(){return window.devicePixelRatio?window.devicePixelRatio*96:null}getConnectionType(){return N.getConnectionType()}}class B{constructor(e){i(this,"event");this.event=e}get session(){return this.event.session}get queueLength(){return this.session.pendingEvents.length}}class O{async get(e){return localStorage.getItem(e)}async set(e,t){localStorage.setItem(e,t)}async remove(e){localStorage.removeItem(e)}}class U{constructor(e){i(this,"_pendingSessions",new Set);i(this,"_storage");this._storage=e}add(e){this._pendingSessions.add(e)}addRange(e){for(const t of e)this.add(t)}remove(e){this._pendingSessions.delete(e)}async save(){const e={v:1,sessions:[...this._pendingSessions].map(t=>t.toStorage())};await this._storage.set("playsaurus-analytics-sessions",JSON.stringify(e))}async restore(){const e=await this._storage.get("playsaurus-analytics-sessions");if(!e)return[];const t=JSON.parse(e);if(t.v!==1)return[];const s=t.sessions.map(r=>v.fromStorage(r));for(const r of s)this.add(r);return s}getAll(){return[...this._pendingSessions]}dequeueAll(){const e=this.getAll();return this._pendingSessions.clear(),e}}class q{constructor(e,t){i(this,"_timeoutId",null);i(this,"_failedAttempts",0);i(this,"_nextFlushAt",null);i(this,"_nextHeartbeatAt",null);i(this,"dateProvider",()=>new Date);i(this,"onFlush");i(this,"debounceTime",15);i(this,"_currentBackoffTime",-1);this.onFlush=e,this.debounceTime=t||this.debounceTime}get failedAttempts(){return this._failedAttempts}get nextFlushAt(){return this._nextFlushAt}get nextHeartbeatAt(){return this._nextHeartbeatAt}get retryTime(){return this._currentBackoffTime}_scheduleNextFlushIn(e){this._timeoutId&&window.clearTimeout(this._timeoutId),e*=1e3,this._nextFlushAt=new Date(Date.now()+e),this._timeoutId=window.setTimeout(this.onFlush,e)}clear(){this._timeoutId&&(window.clearTimeout(this._timeoutId),this._timeoutId=null)}_getExponentialBackoff(e){return Math.min(Math.pow(2,e-1)*this.debounceTime,3600)}scheduleRetry(){this._currentBackoffTime=this._getExponentialBackoff(++this._failedAttempts),this._scheduleNextFlushIn(this._currentBackoffTime)}scheduleNextFlush(){this._failedAttempts=0,this._currentBackoffTime=-1,this._scheduleNextFlushIn(this.debounceTime)}scheduleHeartbeatAt(e){if(!e){this._nextHeartbeatAt=null;return}if(this._nextFlushAt&&e<this._nextFlushAt)return;const t=e.getTime()-this.dateProvider().getTime();this._nextHeartbeatAt=e,this._scheduleNextFlushIn(t/1e3)}get isHeartbeatTime(){if(this._nextHeartbeatAt===null)return!1;const e=10*1e3,t=this.dateProvider().getTime(),s=this._nextHeartbeatAt.getTime();return t>=s-e&&t<=s+e}}class A{constructor(){i(this,"_start");this._start=new Date().getTime()}static start(){return new A}get elapsed(){return new Date().getTime()-this._start}}class _ extends Error{constructor(t,s,r){super(t??`Request failed with status code ${(s==null?void 0:s.status)??0}`);i(this,"response");i(this,"shouldRetry");i(this,"duration");this.response=s??null,this.shouldRetry=this._shouldRetry(s),this.duration=r??0}static fromResponse(t,s){return new _(void 0,t,s)}static deviceOffline(){return new _("Device is offline")}_shouldRetry(t){if(!t)return!1;const s=Math.floor(((t==null?void 0:t.status)??0)/100);return s===5||s===0||t.status===429}}class W{constructor(e){i(this,"baseUrl","");i(this,"supportsBeaconAPI",navigator.sendBeacon!==void 0);this.baseUrl=e}async send(e,t){const s=this._getEventPayload(t,e),r=A.start(),a=await fetch(`${this.baseUrl}/events`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(s),keepalive:!0}),l=r.elapsed;if(!a.ok)throw _.fromResponse(a,l);const p=await a.json();return{response:a,duration:l,data:p}}sendHeartbeat(e){return this.send(e,[])}sendWithBeaconAPI(e,t){if(!this.supportsBeaconAPI)return!1;const s=this._getEventPayload(t,e),r=new Blob([JSON.stringify(s)],{type:"application/json"});return navigator.sendBeacon(`${this.baseUrl}/events`,r)}_getEventPayload(e,t){const s=t.id===null;return{ts:new Date().toISOString(),events:e.map(r=>r.toJSON()),session:s?t.toJSON():void 0,session_id:s?void 0:t.id}}}class ${constructor(e,t,s){i(this,"events");i(this,"response",null);i(this,"duration",-1);i(this,"innerError",null);this.events=e,this.response=t instanceof _?t.response:null,this.innerError=t??null,this.duration=s??-1}get session(){return this.events[0].session}}class M{constructor(e){i(this,"events");this.events=e}get session(){return this.events[0].session}}class z{constructor(e,t,s){i(this,"events");i(this,"response",null);i(this,"duration",0);this.events=e,this.response=t??null,this.duration=s??-1}get session(){return this.events[0].session}}class j{constructor(e,t){i(this,"onEventsSending",()=>{});i(this,"onEventsSent",()=>{});i(this,"onEventsFailed",()=>{});i(this,"_broker");i(this,"maxEventsPerRequest",20);this._broker=new W(e),this.maxEventsPerRequest=t??20}_createBatches(e){return e.flatMap(t=>t.createBatches(this.maxEventsPerRequest))}async flush(e){if(e.length===0)return[];const t=this._createBatches(e);let s=!1;for(let r=0;r<t.length;r++){const a=t[r];if(s){a.markAsFailAndRetry();continue}if(await this._sendbatch(a),a.shouldRetry){s=!0;break}}if(s)for(const r of t.filter(a=>a.shouldRetry))r.session.returnFailedEventsToQueue(r.events);return t}async sendHeartbeat(e){const{data:t}=await this._broker.sendHeartbeat(e);e.id=t.session_id,e.nextHeartbeatAt=new Date(t.next_heartbeat_at)}flushWithBeacon(e){if(e.length===0)return[];const t=this._createBatches(e);for(const s of t)this._sendItemWithBeaconAPI(s);return t}_sendItemWithBeaconAPI(e){const{session:t,events:s}=e;if(t.userAtomicId===null){e.markAsFailAndRetry();return}if(navigator.onLine===!1){e.markAsFailAndRetry();return}this.onEventsSending(new M(s)),this._broker.sendWithBeaconAPI(t,s)?e.markAsSent():e.markAsFailAndRetry()}async _sendbatch(e){const{session:t,events:s}=e;if(t.userAtomicId===null){e.markAsFailAndRetry();return}if(navigator.onLine===!1){e.markAsFailAndRetry();return}this.onEventsSending(new M(s));try{const{response:r,duration:a,data:l}=await this._broker.send(t,s);t.id=l.session_id,t.nextHeartbeatAt=new Date(l.next_heartbeat_at),this.onEventsSent(new z(s,r,a)),e.markAsSent()}catch(r){const a=r instanceof _?r.shouldRetry:!0,l=r instanceof _?r.duration:0;a?e.markAsFailAndRetry():e.markAsFailAndSkip(),this.onEventsFailed(new $(s,r,l))}}}class J{constructor(e,t){i(this,"batches");i(this,"retryAfter");this.batches=e,this.retryAfter=t}}var b=(n=>(n.Other="other",n.Web="web",n.Steam="steam",n.Ios="ios",n.Android="android",n))(b||{});class Q{constructor(e){i(this,"sdkVersion",g.version);i(this,"gameVersion",null);i(this,"endpoint","");i(this,"platform",b.Web);i(this,"maxEventsPerRequest",20);i(this,"flushDebounceTime",15);i(this,"_onEventQueued");i(this,"_onRetryScheduled");i(this,"_session",null);i(this,"_pendingSessions");i(this,"_isSending",!1);i(this,"_scheduler");i(this,"_dataCollector");i(this,"_storage");i(this,"_flushingService");if(!e.gameSlug)throw new Error("The game slug is required.");if(!e.endpoint)throw new Error("The endpoint is required.");this.endpoint=`${e.endpoint}/games/${e.gameSlug}`,this.gameVersion=e.gameVersion??null,this.platform=e.gamePlatform??b.Web;const t=e.analytics??{};this.maxEventsPerRequest=t.maxEventsPerRequest??20,this.flushDebounceTime=t.flushDebounceTime??15,this._onEventQueued=t.onEventQueued??(()=>{}),this._onRetryScheduled=t.onRetryScheduled??(()=>{}),this._dataCollector=t.dataCollector??new k,this._storage=t.storageDriver??new O,this._pendingSessions=new U(this._storage),this._flushingService=new j(this.endpoint,this.maxEventsPerRequest),this._flushingService.onEventsSending=t.onAnalyticsSending??(()=>{}),this._flushingService.onEventsSent=t.onAnalyticsSent??(()=>{}),this._flushingService.onEventsFailed=t.onAnalyticsFailed??(()=>{}),this._scheduler=new q(()=>this.flush(),this.flushDebounceTime),this._session=this._newSession(),this._pendingSessions.restore(),window.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&this._flushWithBeaconAPI()}),this._scheduler.scheduleNextFlush()}notifyLocaleChanged(){this.sendEvent("locale_changed",{locale:g.locale})}_newSession(){const e=new v;return this._session=e,this.sendEvent("session_started"),this._collectData(e),e}async endSession(){if(this._scheduler.clear(),!this._session)return Promise.resolve();this.sendEvent("session_ended"),await this.flush(),this._session=null}_getActiveSession(){return this._session??(this._session=this._newSession()),this._session}sendEvent(e,t){const s=this._getActiveSession(),r=s.pushEvent(e,t);this._pendingSessions.add(s),this._onEventQueued(new B(r)),s.pendingEvents.length>=this.maxEventsPerRequest?this._scheduler.failedAttempts===0&&this.flush():this._scheduler.scheduleNextFlush()}async _collectData(e){e.userAtomicId===null&&(await this._dataCollector.collect(e,{gameVersion:this.gameVersion,analyticsSdkVersion:this.sdkVersion,gamePlatform:this.platform,gameLocale:g.locale,userUid:g.config.userUid??null}),await this._pendingSessions.save())}async flush(){if(!this._isSending){this._isSending=!0;try{await this._pendingSessions.save();const e=this._pendingSessions.dequeueAll(),t=this._scheduler.isHeartbeatTime;if(e.length===0&&t&&this._session!==null){await this._flushingService.sendHeartbeat(this._session),this._isSending=!1;return}const r=(await this._flushingService.flush(e)).filter(a=>a.shouldRetry);r.length>0?(this._pendingSessions.addRange(r.map(a=>a.session)),this._scheduler.scheduleRetry(),this._onRetryScheduled(new J(r,this._scheduler.retryTime))):this._scheduler.scheduleNextFlush(),await this._pendingSessions.save()}finally{this._session&&this._session.nextHeartbeatAt&&this._scheduler.scheduleHeartbeatAt(this._session.nextHeartbeatAt),this._isSending=!1}}}_flushWithBeaconAPI(){if(navigator.sendBeacon===void 0){this.flush();return}const e=this._pendingSessions.getAll(),t=e.filter(r=>r.id===null),s=e.filter(r=>r.id!==null);this._flushingService.flushWithBeacon(t),this._flushingService.flush(s)}}class T{constructor(){i(this,"id","");i(this,"locale","en");i(this,"title","");i(this,"body","");i(this,"button","");i(this,"link","");i(this,"image",{url:"",alt:""});i(this,"_sw",null);i(this,"_clicked",!1);i(this,"_finalReadTime",null)}static fromRequest(e){const t=new T;return t.id=e.id,t.locale=e.locale,t.title=e.title,t.body=e.body,t.button=e.button,t.link=e.link,t.image=e.image,t}start(){if(this._sw!==null)throw new Error("Announcement has already been started.");this._sw=A.start()}markAsClicked(){this.markAsDismissed(!0)}markAsDismissed(e=!1){if(this._sw===null)throw new Error("Announcement has not been started.");this._clicked=e,this._finalReadTime=this._sw.elapsed,this._sw=null}get isRunning(){return this._sw!==null}get clicked(){return this._clicked}get readTime(){return this._finalReadTime!==null?this._finalReadTime:this._sw===null?0:this._sw.elapsed}}class X{constructor(e,t){i(this,"_parent");i(this,"_announcement",null);i(this,"_dialog",null);i(this,"onClicked",()=>{});i(this,"onDismissed",()=>{});i(this,"_options");i(this,"_closeIconSvg",`
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
        </svg>
    `);this._announcement=e,this._parent=document.body,this._options=t||{},this.render()}get announcement(){return this._announcement}set announcement(e){this._announcement!==e&&(this._announcement=e,this.render())}render(){var F,P;if(this._dialog===null&&(this._dialog=document.createElement("dialog"),this._dialog.classList.add("playsaurus-announcement-dialog"),this._dialog.classList.add(this._options.theme||"light"),this._parent.appendChild(this._dialog)),this._announcement===null){this._dialog.innerHTML="";return}const e=this._announcement.title,t=this._announcement.body,s=this._announcement.button||"Learn More",r=(F=this._announcement.image)==null?void 0:F.url,a=((P=this._announcement.image)==null?void 0:P.alt)||e,l=this._announcement.link,p=[];if(r&&p.push(`<img class="image" src="${r}" alt="${a}"/>`),t&&p.push(`<p class="body">${t}</p>`),l){const f=l.startsWith("http")?l:"javascript:void(0)";p.push(`<a href="${f}" target="_blank" class="button">
                ${s}
            </a>`)}const Y=`<button class="close-button">${this._closeIconSvg}</button>`,Z=`<div class="header">
            <h1 class="title">${e}</h1>
            ${Y}
        </div>`;this._dialog.innerHTML=`
            ${Z}
            ${p.join(`
`)}
        `;const C=this._dialog.querySelector("a.button"),x=this._dialog.querySelector("button.close-button");C&&C.addEventListener("click",f=>{var L;l&&!l.startsWith("http")&&f.preventDefault(),(L=this._dialog)==null||L.close(),this.onClicked()}),x&&x.addEventListener("click",f=>{var w;f.preventDefault(),(w=this._dialog)==null||w.close(),this.onDismissed()}),this._options.dismissable&&this._dialog.addEventListener("click",f=>{var w;f.target===this._dialog&&((w=this._dialog)==null||w.close(),this.onDismissed())})}show(){var e;(e=this._dialog)==null||e.showModal()}}class G{constructor(e){i(this,"_endpoint");i(this,"_defaultHeaders",{});i(this,"platform");i(this,"_atomicId",null);if(!e.gameSlug)throw new Error("The game slug is required");if(!e.endpoint)throw new Error("The endpoint is required");this._endpoint=`${e.endpoint}/games/${e.gameSlug}/announcements`,this.platform=e.gamePlatform||b.Web,this._updateHeaders()}notifyLocaleChanged(){this._updateHeaders()}async _getAtomicId(){return this._atomicId||(this._atomicId=await y.instance.getId()),this._atomicId}async fetch(){const e=g.config.userUid||"",t=new URLSearchParams({user_uid:e,platform:this.platform,user_atomic_id:await this._getAtomicId()}),s=await fetch(`${this._endpoint}/latest?${t.toString()}`,{headers:this._defaultHeaders});if(!s.ok)throw new Error(`Failed to fetch latest announcement: ${s.status} ${s.statusText}`);if(s.status===204)return null;const r=await s.json();return T.fromRequest(r)}async fetchAndShowDialog(e){const t=await this.fetch();return this.showDialog(t,e)}async showDialog(e,t){return e?new Promise(s=>{const r=new X(e,t);r.onClicked=()=>{e.markAsClicked(),this.sendInteraction(e),s(e)},r.onDismissed=()=>{e.markAsDismissed(),this.sendInteraction(e),s(e)},e.start(),r.show()}):null}async sendInteraction(e){e.isRunning&&e.markAsDismissed();const t=await fetch(`${this._endpoint}/interactions`,{method:"POST",headers:this._defaultHeaders,body:JSON.stringify({announcement_id:e.id,user_uid:g.config.userUid,user_atomic_id:await this._getAtomicId(),read_time:e.readTime,clicked:e.clicked,locale:e.locale,platform:this.platform})});if(!t.ok)throw new Error(`Failed to send interaction: ${t.status} ${t.statusText}`)}_updateHeaders(){this._defaultHeaders={"Accept-Language":g.locale,"Content-Type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"}}}class K extends k{async collect(e,t){return e.gameVersion=t.gameVersion,e.analyticsSdkVersion=t.analyticsSdkVersion,e.gameLocale=t.gameLocale,e.gamePlatform=t.gamePlatform,e.userUid=t.userUid,e.userAtomicId=await this.getAtomicId(),e.connectionType=this.getConnectionType(),e.screenWidth=this.getScreenWidth(),e.screenHeight=this.getScreenHeight(),e.screenDpi=this.getScreenDpi(),e.screenCount=null,e.deviceType=null,e.deviceCpuCores=null,e.deviceCpuMhz=null,e.deviceVramMb=null,e.gameGraphicsApi=null,e.deviceLocale=navigator.language,e.deviceRamMb=this.getDeviceRamMb(),e.userAgent=navigator.userAgent,new Promise((s,r)=>{const a=()=>{try{e.osName=this.getOsName(),e.osVersion=this.getOsVersion(),e.deviceModel=this.getDeviceModel(),e.deviceManufacturer=this.getDeviceManufacturer(),s()}catch(l){r(l)}};document.addEventListener("deviceready",a)})}getDeviceModel(){return typeof device<"u"?device.model:null}getDeviceManufacturer(){return typeof device<"u"?device.manufacturer:null}getOsName(){if(typeof device<"u")switch(device.platform){case"ios":return I.IOS;case"android":return I.Android}return null}getOsVersion(){return typeof device<"u"?device.version:null}}const d=class d{static get locale(){var e;return((e=this._config)==null?void 0:e.locale)??"en"}static set locale(e){var t,s;if(e!==this.locale){if(!this._config)throw new Error("The Playsaurus SDK has not been initialized. Call Playsaurus.initialize() first.");this._config.locale=e.replace("_","-"),(t=this._analytics)==null||t.notifyLocaleChanged(),(s=this._announcements)==null||s.notifyLocaleChanged()}}static initialize(e){var s;if(this._instance!==null)throw new Error("The Playsaurus SDK has already been initialized.");const t=e.endpoint||d.DEFAULT_ENDPOINT;e.endpoint=t==null?void 0:t.replace(/\/$/,""),this._config=e,(((s=e.analytics)==null?void 0:s.enabled)??!1)&&(this._analytics=new Q(e))}static _unitializedError(){return new Error("The Playsaurus SDK has not been initialized. Call Playsaurus.initialize() first.")}static get config(){if(!this._config)throw this._unitializedError();return this._config}static get analytics(){if(!this._config)throw this._unitializedError();if(!this._analytics)throw new Error("The analytics service has not been enabled. Enable it in the PlaysaurusConfig.");return this._analytics}static get announcements(){if(!this._config)throw this._unitializedError();return this._announcements??(this._announcements=new G(this._config))}static async getAtomicId(){return y.instance.getId()}};i(d,"version","4.1.0"),i(d,"DEFAULT_ENDPOINT","https://app.playsaurus.com/api"),i(d,"BrowserDataCollector",k),i(d,"CordovaDataCollector",K),i(d,"_instance",null),i(d,"_analytics",null),i(d,"_announcements",null),i(d,"_config",null);let g=d;return g});
